<!DOCTYPE html>
  <html>
    <head>
      <link href="https://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet">
      <title>Just sitting</title>
      <link rel="icon" 
        type="image/png" 
        href="https://cdn.glitch.com/beeb51f9-1344-467c-a2f1-0cfe203a9643%2Fjust-sitting.png?v=1587314467138">
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <style>
        html { height: 100%; font-family: 'Montserrat', sans-serif; }
        body {
          background-image: linear-gradient(141deg, #92cded 0%, #1fc8db 51%, #2cb5e8 75%);
          color: white;
          text-shadow: 1px 1px 3px #040404;
          height: 100%;
          display: flex;
          flex-direction: column;
          justify-content: center;
          text-align: center;
          margin: 0;
        }
        button {
          height: 40px;
          border-radius: 5px;
          border: none;
          padding: 10px;
          margin: 5px;
          box-shadow: 1px 1px 2px #888;
          background-color: white;
          cursor: pointer;
          display: flex;
          align-items: center;
          justify-content: center;
        }
        .header {
          text-align: left;
          position: fixed;
          left: 0;
          top: 0;
          display: flex;
          justify-content: space-between;
          width: 100%
        }
        .header div {
          display: flex;
          padding: 15px;
        }
        .footer {
          position: fixed;
          left: 0;
          bottom: 0;
          width: 100%;
          padding: 10px;
          text-align: center;
        }
        #sitters {
          margin: auto;
          max-width: 300px;
        }
        .sitter {
          font-size: 80px;
          width: 80px;
          display: block;
        }
        #questions {
          margin: 0.5rem;
        }
        #complete-form {
          max-width: 200px;
          margin: auto;
          display: none;
        }
        @media only screen and (max-width: 600px) {
          #sitters {
            max-width: 200px;
          }
          .sitter {
            font-size: 60px;
            width: 60px;
          }
        }
      </style>
    </head>

    <body>
      <audio id="audio" volume="0.5">
        <source src="https://cdn.glitch.com/beeb51f9-1344-467c-a2f1-0cfe203a9643%2FTemple%20Bell-SoundBible.com-756181215.mp3?v=1587732536317" type="audio/mpeg">
      </audio>
      
      <div class="header">
        <div id="timer">
<!--           <button id="love-button">❤️</button>
          <button id="peace-button">✌️</button> -->
        </div>
        <div style="flex-direction: column">
          <button onclick="toggleMuted()">
            <span>Gong:&nbsp;</span>
            <img id="mute-button" src="https://cdn.glitch.com/beeb51f9-1344-467c-a2f1-0cfe203a9643%2Fsound-on.svg?v=1587733304416">
          </button>
          <p style="font-size: 8px">
            (requires site audio enabled)
          </p>
        </div>
      </div>

      <div class="app">
        <div id="sitters" style="display: flex; justify-content: center; flex-wrap: wrap;">
          <!-- This is where the sitters will go. -->
        </div>
        <p id="question">
          Welcome,<br/>
          Just sit and follow your breath until the timer runs out.
        </p>
        <div id="complete-form">
          <div style="display: flex; margin-bottom: 10px">
            <label for="glad" style="flex: 1; text-align: left; margin-right: 5px;">Glad that I did this</label>
            <input id="glad" type="checkbox" /><br />
          </div>
          <div style="display: flex; margin-bottom: 10px">
            <label for="calmer" style="flex: 1; text-align: left; margin-right: 5px;">Calmer</label>
            <input id="calmer" type="checkbox" /><br />
          </div>
          <div style="display: flex; margin-bottom: 10px">
            <label for="more-grateful" style="flex: 1; text-align: left; margin-right: 5px;">More Grateful</label>
            <input id="more-grateful" type="checkbox" /><br />
          </div>

          <div style="display: flex; margin-bottom: 10px">
            <label for="mentally-clearer" style="flex: 1; text-align: left; margin-right: 5px;">Mentally Clearer</label>
            <input id="mentally-clearer" type="checkbox" /><br />
          </div>

          <div style="display: flex; margin-bottom: 10px">
            <label for="more-capable" style="flex: 1; text-align: left; margin-right: 5px;">More Capable</label>
            <input id="more-capable" type="checkbox" /><br />
          </div>

          <button id="complete-form-submit" style="margin: 20px auto;">
            Submit
          </button>
          <p>
            Do you have thoughts on the site? We'd love your feedback: <a href="mailto:feedback@just-sitting.io?subject=Just-Sitting.io%20feedback">feedback@just-sitting.io</a>
          </p>
        </div>
      </div>

      <div id="footer" class="footer">
<!--         An app made by <a href="https://www.github.com/sejori">sebringrose</a> -->
      </div>

      <script src="/socket.io/socket.io.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/easytimer@1.1.3/dist/easytimer.min.js"></script>
      <script>
        let socket = io("https://just-sitting.glitch.me")
        let session_id
        socket.on("connect", () => session_id = socket.id)
        
        let mySitter = "none"
        let sittersDiv = document.querySelector("#sitters")
        // let muted = JSON.parse(window.localStorage.getItem("muted"))
        let sessionComplete = false
        let muted = true
        
        // SOUND CONTROL LOGIC
        let unmute = () => {
          document.getElementById("mute-button").src = "https://cdn.glitch.com/beeb51f9-1344-467c-a2f1-0cfe203a9643%2Fsound-on.svg?v=1587733304416"
          document.getElementById("audio").play()
          muted = false
        }
        let mute = () => {
          document.getElementById("mute-button").src = "https://cdn.glitch.com/beeb51f9-1344-467c-a2f1-0cfe203a9643%2Fsound-off.svg?v=1587733304382"
          document.getElementById("audio").pause();
          document.getElementById("audio").currentTime = 0;
          muted = true
        }
        if (!muted) {
          unmute() 
        } else mute()
        function toggleMuted() {
          if (muted) {
            unmute()  
          } else {
            mute()
          }
          window.localStorage.setItem("muted", muted)
        }
        
        // SITTER VIEW LOGIC
        var displaySitters = (sitters) => {
          let newSitters = []
          sitters.forEach((sitter, index) => {
            if (index > 8) return null

            let div = document.createElement("div")
            let span = document.createElement("span")
            div.setAttribute("id", "sitter" + index)
            span.setAttribute("class", "sitter")
            
            // "..." in final space if more than 9 sitters
            span.textContent = index === 8 && sitters.length > 9
              ? "..."
              : sitter
            
            div.appendChild(span)
            newSitters.push(div)
          })
          sittersDiv.innerHTML = "";
          newSitters.forEach(div => {
            sittersDiv.appendChild(div)
          })
          
          document.querySelector("#footer").textContent = `${sitters.length} just sitting right now.`
        }
        
        // TIMER & SESSION FINISH LOGIC
        // set-up timer for form from URL params
        const time = document.location.pathname.substring(1) || "10";
        const timer = new Timer();
        const finishSession = () => {
          socket.disconnect();
          
          document.querySelector("#sitters").style.display = "none"
          const questionP = document.querySelector("#question")
          questionP.textContent = `Session complete. How do you feel?`
          
          const completeForm = document.querySelector("#complete-form")
          completeForm.style.display = "block"
          
          document.querySelector("#complete-form-submit").addEventListener("click", () => {
            completeForm.style.display = "none"
          
            const questions = Array.from(completeForm.getElementsByTagName('div')).map(div => {
              const label = div.getElementsByTagName('label')[0]
              const checkbox = div.getElementsByTagName('input')[0]
              return `${label.getAttribute("for")}-${checkbox.checked}`
            })
                                                                    
            fetch("/postResponse", {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({ data: JSON.stringify(questions), session_id })
            })
            questionP.textContent = "Thank you for just sitting with us. Until next time ✌️"
          })
        }
        
        timer.start({ countdown: true, startValues: time === "dev" ? { seconds: 1 } : { minutes: Number(time) } });
        
        document.querySelector("#timer").textContent = timer.getTimeValues().toString();
        timer.addEventListener('secondsUpdated', function (e) {
          document.querySelector("#timer").textContent = timer.getTimeValues().toString();
        });
        timer.addEventListener('targetAchieved', finishSession);
        
        // WEBSOCKET LISTENERS
        socket.on('question update', (question) => {
          if (sessionComplete) return
          if (muted != "true") document.getElementById("audio").play()
          document.getElementById("question").innerHTML = question
        })
        socket.on('sitters', (sitters) => displaySitters(sitters))
        socket.on('sitter', (sitter) => mySitter = sitter)
      </script>

    </body>
  </html>
