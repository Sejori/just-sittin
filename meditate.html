<!doctype html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="shortcut icon" href="assets/logo.png" type="image/x-icon">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="output.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@200;400;500&display=swap" rel="stylesheet">
  <title>Just Sitting | Let's Sit...</title>

</head>
<body class="min-h-screen bg-cover bg-center bg-gradient-to-b from-cyan-400 via-sky-200 to-pink-200">

    <header class="p-6 logo flex align-middle items-center justify-between">

        <!-- Left Menu -->
        <div>
            <div class="logo flex align-middle items-center">
                <img src="assets/logo.png" alt="Just Sitting Logo" class="w-14 h-14">
                <p id="timer"></p>
            </div>  
        </div>

        <!-- Right Menu -->
        <div>
            <div class="relative inline-block text-left">
                <div class="hover:cursor-pointer text-xl">
                    🧘🏻‍♂️ me
                </div>

                <!--
                    Dropdown menu, show/hide based on menu state.

                    Entering: "transition ease-out duration-100"
                    From: "transform opacity-0 scale-95"
                    To: "transform opacity-100 scale-100"
                    Leaving: "transition ease-in duration-75"
                    From: "transform opacity-100 scale-100"
                    To: "transform opacity-0 scale-95"
                -->
                <div class="origin-top-right absolute right-0 mt-2 w-40 rounded-lg rounded-tr-none rounded-bl-none shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none text-right" role="menu" aria-orientation="vertical" aria-labelledby="menu-button" tabindex="-1">
                    <div class="py-1" role="none">
                    <!-- Active: "bg-gray-100 text-gray-900", Not Active: "text-gray-700" -->
                    <a href="#" class="text-gray-700 block px-4 py-2 text-sm" role="menuitem" tabindex="-1" id="menu-item-0">Turn Sound On</a>
                    <a href="#" class="text-gray-700 block px-4 py-2 text-sm" role="menuitem" tabindex="-1" id="menu-item-1">Request a Feature</a>

                    </div>
                </div>
            </div>
            

        </div>
       
    </header>  

    <section class="main-content">

    </section>
        

    <section class="animation w-2/3 mx-auto absolute top-0 left-0 flex h-screen w-screen align-middle items-center">

        <div class="breathing mx-auto opacity-50">
            <dixwv class="circle"></dixwv>
            <div class="circle"></div>
            <div class="circle"></div>
            <div class="circle"></div>
            <div class="circle"></div>
            <div class="circle"></div>
        </div>


    </section>

    <section class="just-sitting-counter p-5 text-center mx-auto opacity:30">
        <p id="sitters" class="text-5xl mx-auto hidden">
            🧘🏻‍♂️🧘🏽‍♂️🧘🏻‍♂️ <br/>
            🧘🏽‍♂️🧘🏻‍♂️🧘🏽‍♂️<br/>
            🧘🏻‍♂️🧘🏽‍♂️🧘🏻‍♂️ <br/>
        </p>
        <p id="question" class="text-5xl mx-auto">
            What are you grateful for today?
        </p>
    </section>

    <section class="sitting-count bottom-0 p-5 text-center w-full absolute opacity-20 hover:opacity-70">
        <p id="footer-text" class="text-xl text-slate-500 mt-5">You are sitting with 0 others.</p>
    </section>

    <section class="select-time flex container mx-auto space-x-6 max-w-2xl hidden">
        <button class="text-white px-5 py-7 font-bold bg-opacity-80 bg-black rounded-xl block w-3/4 mx-auto hover:bg-opacity-100 mb-6">
            3 mins
        </button>
        <button class="text-white px-5 py-7 font-bold bg-opacity-80 bg-black rounded-xl block w-3/4 mx-auto hover:bg-opacity-100 mb-6">
            5 mins
        </button>
        <button class="text-white px-5 py-7 font-bold bg-opacity-80 bg-black rounded-xl block w-3/4 mx-auto hover:bg-opacity-100 mb-6">
            10 mins
        </button>

        <button class="text-white px-5 py-7 font-bold bg-opacity-80 bg-black rounded-xl block w-3/4 mx-auto hover:bg-opacity-100 mb-6">
            10 mins
        </button>
    </section>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/easytimer@1.1.3/dist/easytimer.min.js"></script>
    <script>
        const socket = io("https://just-sitting.glitch.me")
        let session_id
        socket.on("connect", () => session_id = socket.id)
        
        let mySitter = "-"
        const sittersP = document.querySelector("#sitters")
        const questionP = document.querySelector("#question")
        const footerP = document.querySelector("#footer-text")

        // let muted = JSON.parse(window.localStorage.getItem("muted"))
        let sessionComplete = false
        let muted = true
        
        // SOUND CONTROL LOGIC
        let unmute = () => {
            document.getElementById("mute-button").src = "https://cdn.glitch.com/beeb51f9-1344-467c-a2f1-0cfe203a9643%2Fsound-on.svg?v=1587733304416"
            document.getElementById("audio").play()
            muted = false
        }
        let mute = () => {
            document.getElementById("mute-button").src = "https://cdn.glitch.com/beeb51f9-1344-467c-a2f1-0cfe203a9643%2Fsound-off.svg?v=1587733304382"
            document.getElementById("audio").pause();
            document.getElementById("audio").currentTime = 0;
            muted = true
        }
        function toggleMuted() {
            if (muted) { unmute() } else { mute() }
            window.localStorage.setItem("muted", muted)
        }
        toggleMuted()
        
        // SITTER VIEW LOGIC
        var displaySitters = (sitters) => {
            let newSitters = []
            sitters.forEach((sitter, index) => {
                if (index > 8) return null

                // let div = document.createElement("div")
                // let span = document.createElement("span")
                // div.setAttribute("id", "sitter" + index)
                // span.setAttribute("class", "sitter")
                
                // "..." in final space if more than 9 sitters
                sitterspan.textContent = 
                
                // div.appendChild(span)
                newSitters.push(index === 8 && sitters.length > 9
                    ? "..."
                    : sitter
                )
            })
            sittersP.innerHTML = "";
            newSitters.forEach(div => {
                sittersP.appendChild(div)
            })
            
            footerP.textContent = `You are sitting with ${sitters.length-1} others.`
        }
        
        // TIMER & SESSION FINISH LOGIC
        // set-up timer for form from URL params
        const time = document.location.pathname.substring(1) || "10";
        const timer = new Timer();
        const finishSession = () => {
            socket.disconnect();
            
            sittersP.style.display = "none"
            questionP.textContent = `Session complete. How do you feel?`
            
            const completeForm = document.querySelector("#complete-form")
            completeForm.style.display = "block"
            
            document.querySelector("#complete-form-submit").addEventListener("click", () => {
            completeForm.style.display = "none"
            
            const questions = Array.from(completeForm.getElementsByTagName('div')).map(div => {
                const label = div.getElementsByTagName('label')[0]
                const checkbox = div.getElementsByTagName('input')[0]
                return `${label.getAttribute("for")}-${checkbox.checked}`
            })
                                                                    
            fetch("/postResponse", {
                method: 'POST',
                headers: {
                'Content-Type': 'application/json'
                },
                body: JSON.stringify({ data: JSON.stringify(questions), session_id })
            })
            questionP.textContent = "Thank you for just sitting with us. Until next time ✌️"
            })
        }
        
        timer.start({ countdown: true, startValues: time === "dev" ? { seconds: 1 } : { minutes: Number(time) } });
        
        document.querySelector("#timer").textContent = timer.getTimeValues().toString();
        timer.addEventListener('secondsUpdated', function (e) {
            document.querySelector("#timer").textContent = timer.getTimeValues().toString();
        });
        timer.addEventListener('targetAchieved', finishSession);
        
        // WEBSOCKET LISTENERS
        socket.on('question update', (question) => {
            if (sessionComplete) return
            if (muted != "true") document.getElementById("audio").play()
            document.getElementById("question").innerHTML = question
        })
        socket.on('sitters', (sitters) => displaySitters(sitters))
        socket.on('sitter', (sitter) => mySitter = sitter)
    </script>
</body>
</html>